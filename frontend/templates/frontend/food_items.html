{% extends 'frontend/base.html' %}

{% block title %}Food Items{% endblock %}

{% block content %}
<h1>Food Items</h1>

<form method="get" class="mb-4">
    <div class="row">
        <div class="col-md-4">
            <input type="text" name="search" class="form-control" placeholder="Search food items" value="{{ search }}">
        </div>
        <div class="col-md-4">
            <input type="text" name="category" class="form-control" placeholder="Filter by category"
                value="{{ category }}">
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </div>
</form>

<div class="row">
    {% for item in food_items %}
    <div class="col-md-4 mb-3">
        <div class="card">
            {% if item.image %}
            <img src="{{ item.image }}" class="card-img-top" alt="{{ item.name }}">
            {% endif %}
            <div class="card-body">
                <h5 class="card-title">{{ item.name }}</h5>
                <p class="card-text">{{ item.description }}</p>
                <p class="card-text"><strong>${{ item.price }}</strong></p>
                <p class="card-text">Category: {{ item.category.name }}</p>
                <a href="#" class="btn btn-success add-to-cart" data-food-item-id="{{ item.id }}">Add to Cart</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addToCartButtons = document.querySelectorAll('.add-to-cart');
        addToCartButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const foodItemId = this.getAttribute('data-food-item-id');
                addToCart(foodItemId);
            });
        });

        function addToCart(foodItemId) {
            fetch('/api/carts/add_item/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Token ' + getCookie('auth_token')  // Assuming token is stored in cookie
                },
                body: JSON.stringify({
                    food_item_id: foodItemId,
                    quantity: 1
                })
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login/';
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        alert('Item added to cart!');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}